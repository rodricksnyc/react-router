{"version":3,"sources":["../../src/nodeSettings.ts"],"names":["fs","ini","ApiConfigMap","ApiSettings","DefaultSettings","ValueSettings","sdkError","unquote","getenv","name","defaultValue","undefined","val","process","env","ApiConfig","contents","parse","ApiConfigSection","section","config","Object","keys","settings","Error","api_version","console","warn","readEnvConfig","envPrefix","values","configMap","forEach","key","envKey","readIniConfig","fileName","existsSync","readFileSync","NodeSettings","constructor","readConfig","_section","NodeSettingsIniFile","message"],"mappings":"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","sourcesContent":["/*\n\n MIT License\n\n Copyright (c) 2021 Looker Data Sciences, Inc.\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in all\n copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n SOFTWARE.\n\n */\n\nimport * as fs from 'fs'\nimport * as ini from 'ini'\nimport type { IApiSettings, IApiSection } from '@looker/sdk-rtl'\nimport {\n  ApiConfigMap,\n  ApiSettings,\n  DefaultSettings,\n  ValueSettings,\n  sdkError,\n  unquote,\n} from '@looker/sdk-rtl'\n\n/**\n * Read an environment key. Use defaultValue if it doesn't exist\n * @param {string} name Environment variable name\n * @param {string | undefined} defaultValue\n * @returns {string | undefined} The value of the environment variable if it exists, or defaultValue\n */\nexport const getenv = (\n  name: string,\n  defaultValue: string | undefined = undefined\n) => {\n  const val = process.env[name]\n  return val === undefined ? defaultValue : val\n}\n\n/**\n * Complete .INI file parse results\n */\nexport interface IApiConfig {\n  [key: string]: any\n}\n\n/**\n * Parses `.ini` formatted content\n * @param contents formatted as an `.ini` file\n * @constructor\n */\nexport const ApiConfig = (contents: string): IApiConfig => ini.parse(contents)\n\n/**\n * Extract named or (default) first section from INI file\n * @param contents {string} Parameters formatted as an INI file\n * @param section {[key: string]: any;} Contents of INI section\n * @constructor\n */\nexport const ApiConfigSection = (\n  contents: string,\n  section?: string\n): IApiSection => {\n  const config = ApiConfig(contents)\n  if (!section) {\n    // default to the first section if not specified\n    section = Object.keys(config)[0]\n  }\n  const settings = config[section]\n  if (!settings) {\n    throw new Error(`No section named \"${section}\" was found`)\n  }\n  if (settings.api_version) {\n    console.warn(\n      'api_version is no longer read from a configuration file by the SDK'\n    )\n  }\n  return settings\n}\n\n/**\n * A utility function that loads environment variables and maps them to the standard configuration values\n *\n * @returns the populated `IApiSection`, which may be empty\n */\nexport const readEnvConfig = (envPrefix: string) => {\n  const values: IApiSection = {}\n  const configMap = ApiConfigMap(envPrefix)\n  Object.keys(configMap).forEach((key) => {\n    const envKey = configMap[key]\n    if (process.env[envKey] !== undefined) {\n      // Value exists. Map environment variable keys to config variable keys\n      const val = unquote(process.env[envKey])\n      values[key] = val\n    }\n  })\n  return values\n}\n\n/**\n * A utility function that loads the configuration values from the specified file name and overrides them\n * with environment variable values, if the environment variables exist\n *\n * @param {string} fileName Name of configuration file to read\n * @param envPrefix environment variable prefix. Pass an empty string to skip environment reading.\n * @param {string} section Optional. Name of section of configuration file to read\n * @returns {IApiSection} containing the configuration values\n */\nexport const readIniConfig = (\n  fileName: string,\n  envPrefix: string,\n  section?: string\n) => {\n  // get environment variables\n  let config = readEnvConfig(envPrefix)\n  if (fileName && fs.existsSync(fileName)) {\n    // override any config file settings with environment values if the environment value is set\n    config = {\n      ...ApiConfigSection(fs.readFileSync(fileName, 'utf8'), section),\n      ...config,\n    }\n  }\n  // Unquote any quoted configuration values\n  Object.keys(config).forEach((key) => {\n    const val = config[key]\n    if (typeof val === 'string') {\n      config[key] = unquote(val)\n    }\n  })\n  return config\n}\n\n/**\n * Read configuration settings from Node environment variables\n *\n * This class initializes SDK settings **only** from the values passed in to its constructor and\n * (potentially) configured environment variables, and does not read a configuration file at all\n *\n * Any environment variables that **are** set, will override the values passed in to the constructor\n * with the same key\n *\n */\nexport class NodeSettings extends ApiSettings {\n  protected readonly envPrefix!: string\n  public section: string\n\n  /**\n   * Initialize config settings for the node SDK runtime\n   * @param envPrefix Environment variable name prefix. Use empty string to not read the environment\n   * @param contents contents of the read config\n   * @param section name of ini section to process\n   */\n  constructor(\n    envPrefix: string,\n    contents?: string | IApiSettings,\n    section?: string\n  ) {\n    let settings: IApiSettings\n    if (contents) {\n      if (typeof contents === 'string') {\n        settings = ApiConfigSection(contents, section) as IApiSettings\n      } else {\n        settings = contents\n      }\n      settings = { ...readEnvConfig(envPrefix), ...settings }\n    } else {\n      settings = readEnvConfig(envPrefix) as IApiSettings\n    }\n    super({ ...DefaultSettings(), ...settings })\n    this.section = section ?? ''\n    this.envPrefix = envPrefix\n  }\n\n  /**\n   * **NOTE**: If `envPrefix` is defined in the constructor, environment variables will be read in this call.\n   *\n   * @param _section section name is ignored here.\n   */\n  readConfig(_section?: string): IApiSection {\n    return readEnvConfig(this.envPrefix)\n  }\n}\n\n/**\n * Example class that reads a configuration from a file in node\n *\n * If `fileName` is not specified in the constructor, the default file name is `./looker.ini`\n *\n * **Warning**: `.ini` files storing credentials should be secured in the run-time environment, and\n * ignored by version control systems so credentials never get checked in to source code repositories.\n * A recommended pattern is using Node environment variables to specify confidential API credentials\n * while using an `.ini` file for values like `base_url`.\n *\n * **Note**: If the configuration file is specified but does **not** exist, an error will be thrown.\n * No error is thrown if the fileName defaulted to `./looker.ini` inside the constructor and that\n * file does not exist. In that case, configuration from environment variables will be required.\n *\n */\nexport class NodeSettingsIniFile extends NodeSettings {\n  private readonly fileName!: string\n\n  constructor(envPrefix: string, fileName = '', section?: string) {\n    if (fileName && !fs.existsSync(fileName)) {\n      throw sdkError({ message: `File ${fileName} was not found` })\n    }\n    // default fileName to looker.ini\n    fileName = fileName || './looker.ini'\n    const config = readIniConfig(fileName, envPrefix, section)\n    const settings = ValueSettings(config, envPrefix)\n    super(envPrefix, settings, section)\n    this.fileName = fileName\n  }\n\n  /**\n   * Read a configuration section and return it as a generic keyed collection\n   * If the configuration file doesn't exist, environment variables will be used for the values\n   * Environment variables, if set, also override the configuration file values\n   *\n   * **NOTE**: If `envPrefix` is defined in the constructor, environment variables will be read in this call.\n   *\n   * @param section {string} Name of Ini section to read. Optional. Defaults to first section.\n   *\n   */\n  readConfig(section?: string): IApiSection {\n    section = section || this.section\n    return readIniConfig(this.fileName, this.envPrefix, section)\n  }\n}\n"],"file":"nodeSettings.js"}